<!DOCTYPE html>
<html lang="en">
<body bgcolor="#F1F1F1">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Rule Manager</title>
<!-- jquery css -->
<link href="stylesheet.css" rel="stylesheet" type="text/css" />
<!-- jquery scripts -->
<script type="text/javascript" src="//code.jquery.com/jquery-1.9.1.js"></script>
<script type="text/javascript" src="//code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
<script type="text/javascript" src="jshashtable-3.0.js"></script>
<script type="text/javascript">
// find logged in user's said
var said = null;
$.ajax({
  type: "GET",
  url: "/dime-communications/web/access/auth/@me",
  success: function(response) {
    said = response;
  },
  error: function(xhr, error){
    console.debug(xhr);
    console.debug(error);
    alert("An error ocurred, and user said couldn't be found!");
  }
});
</script>

<script type="application/javascript">
    var conditionsHashMap = new Hashtable();
	var conditionsKeyPress = new Hashtable();
	var conditionsMousePress = new Hashtable();
	
	var currentConditionId = "";
	var conditions = 0;
	var currentRuleId = "";
	//start tutorial at step 1
	var tutorialCounter = 1;
	
	var user = $.now();
	
	var conditionObjects = new Hashtable();
	
	var currentTypeId = -1;
	var currentPropertyId = -100;
	var currentValueId = -100;
	var currentURITag = "";
	
var types = [
		   {
			value: 0,
			label: "Email",
			propertyQuery: "select distinct * where { { ?x <http://www.w3.org/2000/01/rdf-schema#domain> <http://www.semanticdesktop.org/ontologies/2007/03/22/nmo#Email>. } union { ?x <http://www.w3.org/2000/01/rdf-schema#domain> <http://www.semanticdesktop.org/ontologies/2007/03/22/nmo#Message>.} ?x <http://www.w3.org/2000/01/rdf-schema#range> <http://www.semanticdesktop.org/ontologies/2007/03/22/nco#ContactMedium> .  optional { ?x <http://www.w3.org/2000/01/rdf-schema#label> ?label . } optional { ?x <http://www.semanticdesktop.org/ontologies/2007/08/15/nao#prefLabel> ?label . } optional {?x <http://www.semanticdesktop.org/ontologies/2007/08/15/nao#deprecated> ?flag .} filter (!bound(?flag)) }",
			constraintQuery: "select distinct ?p ?label where { { ?p a <http://www.semanticdesktop.org/ontologies/2007/11/01/pimo#Person> . ?p <http://www.semanticdesktop.org/ontologies/2007/11/01/pimo#occurrence> ?y . optional { ?p<http://www.semanticdesktop.org/ontologies/2007/08/15/nao#prefLabel> ?label . } ?y <http://www.semanticdesktop.org/ontologies/2007/03/22/nco#ContactMedium> . } }",
			constraintId: "y",
			image: "../../images/rules/email.png",
			json: '{ "and": #andURI, "conditionType": "drmo:Condition", "conditions": [ { "and": null, "conditionType": "drmo:Condition", "conditions": [],  "constraintOnGraph": null, "constraintOnObject": { "and": null, "conditionType": "drmo:Condition", "conditions": [],  "constraintOnGraph": null, "constraintOnObject": null,  "constraintOnProperty": "nco:hasEmailAddress",  "constraintOnSubject": {	"and": null, "conditionType": "drmo:Condition", "conditions": [],  "constraintOnGraph": null, "constraintOnObject": null,  "constraintOnProperty": "pimo:Occurance",  "constraintOnSubject": #subject, "guid":"#guid_1_1_1", "isNegated": false,  "or": null, "preceededBy": null, "propertyOperator": null, "resourceType": "nco:ContactMedium",  "succeededBy": null }, "guid":"#guid_1_1",  "isNegated": false,  "or": null, "preceededBy": null, "propertyOperator": null, "resourceType": "nmo:EmailAddress",  "succeededBy": null  } , "constraintOnProperty": #property,  "constraintOnSubject": null, "guid":"#guid_1",  "isNegated": false,  "or": null, "preceededBy": null, "propertyOperator": null, "resourceType": "nmo:Email",  "succeededBy": null }  ],  "constraintOnGraph": null, "constraintOnObject": null,  "constraintOnProperty": null,  "constraintOnSubject": null, "guid":"#guid",  "isNegated": false,  "or": #orURI, "preceededBy": #precURI, "propertyOperator": null, "resourceType": "nmo:Email",  "succeededBy": #succURI }',
		  },
		  {
			value: 1,
			label: "Nearby People",
			propertyQuery: "select distinct * where {  ?x <http://www.w3.org/2000/01/rdf-schema#domain> <http://www.semanticdesktop.org/ontologies/2011/10/05/dcon#Peers> .  optional { ?x <http://www.w3.org/2000/01/rdf-schema#label> ?label . } optional { ?x <http://www.semanticdesktop.org/ontologies/2007/08/15/nao#prefLabel> ?label . } optional {?x <http://www.semanticdesktop.org/ontologies/2007/08/15/nao#deprecated> ?flag .} filter (!bound(?flag)) }",
			image: "../../images/rules/persons.png",	
		  },
		  {
			value: 2,
			label: "My Activity or Availability)",
			propertyQuery: "select distinct * where {  ?x <http://www.w3.org/2000/01/rdf-schema#domain> <http://www.semanticdesktop.org/ontologies/2011/10/05/dcon#State> .  optional { ?x <http://www.w3.org/2000/01/rdf-schema#label> ?label . } optional { ?x <http://www.semanticdesktop.org/ontologies/2007/08/15/nao#prefLabel> ?label . } optional {?x <http://www.semanticdesktop.org/ontologies/2007/08/15/nao#deprecated> ?flag .} filter (!bound(?flag)) }",
			constraintQuery: "select distinct * where { ?x a #propertytype# . optional { ?x <http://www.semanticdesktop.org/ontologies/2007/08/15/nao#prefLabel> ?label . } }",
			constraintId: "x",
			image: "../../images/rules/state.png",
			json: '{ "and": #andURI, "conditionType": "drmo:Condition", "conditions": [ {"and": #andURI, "conditionType": "drmo:Condition", "conditions": [],  "constraintOnGraph": null, "constraintOnObject": #object,  "constraintOnProperty": #property,  "constraintOnSubject": null, "guid":"#guid_1",  "isNegated": false,  "or": #orURI, "preceededBy": #precURI, "propertyOperator": null, "resourceType": "nmo:Email",  "succeededBy": #succURI } ],  "constraintOnGraph": null, "constraintOnObject": null,  "constraintOnProperty": null,  "constraintOnSubject": null, "guid":"#guid",  "isNegated": false,  "or": #orURI, "preceededBy": #precURI, "propertyOperator": null, "resourceType": "dcon:State",  "succeededBy": #succURI  }',
		  },
		  {
			value: 3,
			label: "My Situation",
			propertyQuery: "",
			constraintQuery: "select distinct * where { ?x a <http://www.semanticdesktop.org/ontologies/2011/10/05/dcon#Situation> . optional { ?x <http://www.semanticdesktop.org/ontologies/2007/08/15/nao#prefLabel> ?label . } }",
			constraintId: "x",
			image: "../../images/rules/situation.png",
			json: '{ "and": #andURI, "conditionType": "drmo:SituationActivated", "conditions": [],  "constraintOnGraph": null, "constraintOnObject": #object,  "constraintOnProperty": "dcon:hasSituation",  "constraintOnSubject": null, "guid":"#guid",  "isNegated": false,  "or": #orURI, "preceededBy": #precURI, "propertyOperator": null, "resourceType": "pimo:Person",  "succeededBy": #succURI }',
		  },
		  {
			value: 4,
			label: "Image",
			propertyQuery: "select distinct * where {  ?x <http://www.w3.org/2000/01/rdf-schema#domain> <http://www.semanticdesktop.org/ontologies/2007/03/22/nfo#Image> .  optional { ?x <http://www.w3.org/2000/01/rdf-schema#label> ?label . } optional { ?x <http://www.semanticdesktop.org/ontologies/2007/08/15/nao#prefLabel> ?label . } optional {?x <http://www.semanticdesktop.org/ontologies/2007/08/15/nao#deprecated> ?flag .} filter (!bound(?flag)) }",
			constraintQuery: "select distinct * where { ?x a <http://www.semanticdesktop.org/ontologies/2011/10/05/nfo#Image> . optional { ?x <http://www.semanticdesktop.org/ontologies/2007/08/15/nao#prefLabel> ?label . } }",
			constraintId: "x",
			image: "../../images/rules/image.png",
			json: '{ "and": #andURI, "conditionType": #conditionType, "conditions": [],  "constraintOnGraph": null, "constraintOnObject": null,  "constraintOnProperty": null,  "constraintOnSubject": null, "guid":"#guid",  "isNegated": false,  "or": #orURI, "preceededBy": #precURI, "propertyOperator": null, "resourceType": "nfo:Image",  "succeededBy": #succURI  }',
		  },
		  {
			value: 5,
			label: "Document",
			propertyQuery: "select distinct * where {  ?y <http://www.w3.org/2000/01/rdf-schema#subClassOf> <http://www.semanticdesktop.org/ontologies/2007/03/22/nfo#Document> . ?x <http://www.w3.org/2000/01/rdf-schema#domain> ?y .  optional { ?x <http://www.w3.org/2000/01/rdf-schema#label> ?label . } optional { ?x <http://www.semanticdesktop.org/ontologies/2007/08/15/nao#prefLabel> ?label . } optional {?x <http://www.semanticdesktop.org/ontologies/2007/08/15/nao#deprecated> ?flag .} filter (!bound(?flag)) }",
			constraintQuery: "select distinct ?x ?label where { ?y <http://www.w3.org/2000/01/rdf-schema#subClassOf> <http://www.semanticdesktop.org/ontologies/2007/03/22/nfo#Document> . ?x a ?y . optional { ?x <http://www.semanticdesktop.org/ontologies/2007/08/15/nao#prefLabel> ?label . } }",
			constraintId: "x",
			image: "../../images/rules/document.png",
			json: '{ "and": #andURI, "conditionType": #conditionType, "conditions": [],  "constraintOnGraph": null, "constraintOnObject": null,  "constraintOnProperty": null,  "constraintOnSubject": null, "guid":"#guid",  "isNegated": false,  "or": #orURI, "preceededBy": #precURI, "propertyOperator": null, "resourceType": "nfo:Document",  "succeededBy": #succURI  }',
		  },
		  {
			value: 6,
			label: "LivePost",
			propertyQuery: "select distinct * where {  ?x <http://www.w3.org/2000/01/rdf-schema#domain> <http://www.semanticdesktop.org/ontologies/2011/10/05/dlpo#LivePost>.  optional { ?x <http://www.w3.org/2000/01/rdf-schema#label> ?label . } optional { ?x <http://www.semanticdesktop.org/ontologies/2007/08/15/nao#prefLabel> ?label . } optional {?x <http://www.semanticdesktop.org/ontologies/2007/08/15/nao#deprecated> ?flag .} filter (!bound(?flag)) }",
			constraintQuery: "select distinct ?x ?label where { #property# <http://www.w3.org/2000/01/rdf-schema#domain> ?y .  ?x a ?y . optional { ?x <http://www.semanticdesktop.org/ontologies/2007/08/15/nao#prefLabel> ?label . } }",
			constraintId: "x",
			image: "../../images/rules/post.png",
		  },

		  {	
			value: 7,
			label: "Place",
			propertyQuery: "select distinct * where {  ?x <http://www.w3.org/2000/01/rdf-schema#domain> <http://www.semanticdesktop.org/ontologies/2011/10/05/dcon#SpaTem>. { { ?x <http://www.w3.org/2000/01/rdf-schema#range> <http://www.semanticdesktop.org/ontologies/2007/11/01/pimo#Location> . } union { ?x <http://www.w3.org/2000/01/rdf-schema#range> <http://www.semanticdesktop.org/ontologies/2011/10/05/dpo#Place> . } }  optional { ?x <http://www.w3.org/2000/01/rdf-schema#label> ?label . } optional { ?x <http://www.semanticdesktop.org/ontologies/2007/08/15/nao#prefLabel> ?label . } optional {?x <http://www.semanticdesktop.org/ontologies/2007/08/15/nao#deprecated> ?flag .} filter (!bound(?flag)) }",
			constraintQuery: "select distinct * where { { ?x a <http://www.semanticdesktop.org/ontologies/2011/10/05/dpo#Place> . } union {  ?x a <http://www.semanticdesktop.org/ontologies/2007/11/01/pimo#Location> . } optional { ?x <http://www.semanticdesktop.org/ontologies/2007/08/15/nao#prefLabel> ?label . } }",
			constraintId: "x",
			image: "../../images/rules/place.png",
			json: '{ "and": #andURI, "conditionType": "drmo:Condition", "conditions": [ {"and": #andURI, "conditionType": "drmo:Condition", "conditions": [],  "constraintOnGraph": null, "constraintOnObject": #object,  "constraintOnProperty": #property,  "constraintOnSubject": null, "guid":"#guid_1",  "isNegated": false,  "or": #orURI, "preceededBy": #precURI, "propertyOperator": null, "resourceType": "nmo:Email",  "succeededBy": #succURI } ],  "constraintOnGraph": null, "constraintOnObject": null,  "constraintOnProperty": null,  "constraintOnSubject": null, "guid":"#guid",  "isNegated": false,  "or": #orURI, "preceededBy": #precURI, "propertyOperator": null, "resourceType": "dcon:SpaTem",  "succeededBy": #succURI  }',
		  },
		  {	
			value: 8,
			label: "Event",
			propertyQuery: "select distinct * where {  ?x <http://www.w3.org/2000/01/rdf-schema#domain> <http://www.semanticdesktop.org/ontologies/2011/10/05/dcon#Schedule>. ?x <http://www.w3.org/2000/01/rdf-schema#range> <http://www.semanticdesktop.org/ontologies/2007/04/02/ncal#Event> .   optional { ?x <http://www.w3.org/2000/01/rdf-schema#label> ?label . } optional { ?x <http://www.semanticdesktop.org/ontologies/2007/08/15/nao#prefLabel> ?label . } optional {?x <http://www.semanticdesktop.org/ontologies/2007/08/15/nao#deprecated> ?flag .} filter (!bound(?flag)) }",
			constraintQuery: "select distinct * where {  ?x a <http://www.semanticdesktop.org/ontologies/2007/04/02/ncal#Event> .  optional { ?x <http://www.semanticdesktop.org/ontologies/2007/08/15/nao#prefLabel> ?label . } }",
			constraintId: "x",
			image: "../../images/rules/event.png",
			json: '{ "and": #andURI, "conditionType": "drmo:Condition", "conditions": [ {"and": #andURI, "conditionType": "drmo:Condition", "conditions": [],  "constraintOnGraph": null, "constraintOnObject": #object,  "constraintOnProperty": #property,  "constraintOnSubject": null, "guid":"#guid_1",  "isNegated": false,  "or": #orURI, "preceededBy": #precURI, "propertyOperator": null, "resourceType": "nmo:Email",  "succeededBy": #succURI } ],  "constraintOnGraph": null, "constraintOnObject": null,  "constraintOnProperty": null,  "constraintOnSubject": null, "guid":"#guid",  "isNegated": false,  "or": #orURI, "preceededBy": #precURI, "propertyOperator": null, "resourceType": "dcon:Schedule",  "succeededBy": #succURI  }',
		  },
		   {	
			value: 9,
			label: "Time Period",
			propertyQuery: "select distinct * where {  ?x <http://www.w3.org/2000/01/rdf-schema#domain> <http://www.semanticdesktop.org/ontologies/2011/10/05/dcon#SpaTem>.	{ ?x <http://www.w3.org/2000/01/rdf-schema#range> <http://www.semanticdesktop.org/ontologies/2011/10/05/dpo#TimePeriod> .  }  optional { ?x <http://www.w3.org/2000/01/rdf-schema#label> ?label . } optional { ?x <http://www.semanticdesktop.org/ontologies/2007/08/15/nao#prefLabel> ?label . } optional {?x <http://www.semanticdesktop.org/ontologies/2007/08/15/nao#deprecated> ?flag .} filter (!bound(?flag)) }",
			constraintQuery: "select distinct * where {  ?x a <http://www.semanticdesktop.org/ontologies/2011/10/05/dpo#TimePeriod> . optional { ?x <http://www.semanticdesktop.org/ontologies/2007/08/15/nao#prefLabel> ?label . } }",
			constraintId: "x",
			image: "../../images/rules/timeperiod.png",
			json: '{ "and": #andURI, "conditionType": "drmo:Condition", "conditions": [ {"and": #andURI, "conditionType": "drmo:Condition", "conditions": [],  "constraintOnGraph": null, "constraintOnObject": #object,  "constraintOnProperty": #property,  "constraintOnSubject": null, "guid":"#guid_1",  "isNegated": false,  "or": #orURI, "preceededBy": #precURI, "propertyOperator": null, "resourceType": "nmo:Email",  "succeededBy": #succURI } ],  "constraintOnGraph": null, "constraintOnObject": null,  "constraintOnProperty": null,  "constraintOnSubject": null, "guid":"#guid",  "isNegated": false,  "or": #orURI, "preceededBy": #precURI, "propertyOperator": null, "resourceType": "dcon:SpaTem",  "succeededBy": #succURI  }',
		  },

		];
		
		$.ajaxSetup({cache:false});
	
	var peerConstraints = [
		  { 
		  	//person 
			value: 0,
			constraintQuery: "select distinct ?x ?label ?p where { ?p a <http://www.semanticdesktop.org/ontologies/2007/11/01/pimo#Person> . ?p <http://www.semanticdesktop.org/ontologies/2007/08/15/nao#prefLabel>  ?x . }",
			constraintId: "p",
			json: '{ "and": #andURI, "conditionType": "drmo:Condition", "conditions": [ {"and": #andURI, "conditionType": "drmo:Condition", "conditions": [],  "constraintOnGraph": null, "constraintOnObject": #object,  "constraintOnProperty": #property,  "constraintOnSubject": null, "guid":"#guid_1",  "isNegated": false,  "or": #orURI, "preceededBy": #precURI, "propertyOperator": null, "resourceType": "dcon:Peers",  "succeededBy": #succURI } ],  "constraintOnGraph": null, "constraintOnObject": null,  "constraintOnProperty": null,  "constraintOnSubject": null, "guid":"#guid",  "isNegated": false,  "or": #orURI, "preceededBy": #precURI, "propertyOperator": null, "resourceType": "dcon:Peers",  "succeededBy": #succURI  }'
			
		  } ,
		  {
			  //group 
			  value: 1,
			  constraintQuery: "select distinct ?x ?p ?label where { ?p a <http://www.semanticdesktop.org/ontologies/2007/11/01/pimo#PersonGroup> . ?p <http://www.semanticdesktop.org/ontologies/2007/08/15/nao#prefLabel>  ?x . } ", 
			  constraintId: "p",
		json: '{ "and": #andURI, "conditionType": "drmo:Condition", "conditions": [ {"and": #andURI, "conditionType": "drmo:Condition", "conditions": [],  "constraintOnGraph": null, "constraintOnObject": { "and": #andURI, "conditionType": "drmo:Condition", "conditions": [],  "constraintOnGraph": null, "constraintOnObject": #object,  "constraintOnProperty": "pimo:memberOf",  "constraintOnSubject": null, "guid":"#guid_2",  "isNegated": false,  "or": #orURI, "preceededBy": #precURI, "propertyOperator": null, "resourceType": "pimo:Person",  "succeededBy": #succURI  },  "constraintOnProperty": #property,  "constraintOnSubject": null, "guid":"#guid_1",  "isNegated": false,  "or": #orURI, "preceededBy": #precURI, "propertyOperator": null, "resourceType": "dcon:Peers",  "succeededBy": #succURI } ],  "constraintOnGraph": null, "constraintOnObject": null,  "constraintOnProperty": null,  "constraintOnSubject": null, "guid":"#guid",  "isNegated": false,  "or": #orURI, "preceededBy": #precURI, "propertyOperator": null, "resourceType": "dcon:Peers",  "succeededBy": #succURI  }'
		  }
		  ]	
		  
    var hardCodedLivePostProperties = [
		{
			value:-1,
			label:"creator",
			constraintQuery: "select distinct * where { ?x a <http://www.semanticdesktop.org/ontologies/2007/11/01/pimo#Person> . ?x <http://www.semanticdesktop.org/ontologies/2007/08/15/nao#prefLabel>  ?label . }",
			constraintId: "x"
		}
	]
	
	var hardCodedSharedWithProperty = [
		{
			value:-3,
			label:"Shared With",
		// return all persons
//			constraintQuery: "select distinct ?x ?label ?p where { { ?p a <http://www.semanticdesktop.org/ontologies/2007/11/01/pimo#Person> . ?p <http://www.semanticdesktop.org/ontologies/2007/08/15/nao#prefLabel>  ?x . }  union { ?p a <http://www.semanticdesktop.org/ontologies/2007/11/01/pimo#PersonGroup> . ?p <http://www.semanticdesktop.org/ontologies/2007/08/15/nao#prefLabel>  ?label . } }",
//			just return 'Person' and 'Group' - the queries are a bit of a hack to return this classes through the usual mechanism
			constraintQuery: "select distinct ?label ?p where { { <http://www.semanticdesktop.org/ontologies/2007/11/01/pimo#attendee> <http://www.w3.org/2000/01/rdf-schema#range> ?p .  ?p <http://www.w3.org/2000/01/rdf-schema#label> ?label . } union { <http://www.semanticdesktop.org/ontologies/2007/11/01/pimo#memberOf> <http://www.w3.org/2000/01/rdf-schema#range> ?p .  ?p <http://www.w3.org/2000/01/rdf-schema#label> ?label .  } }" ,
			constraintId: "p",
			id: "http://www.semanticdesktop.org/ontologies/2009/11/08/nso#sharedWith",
			jsonGroup: '{ "and": #andURI, "conditionType": "drmo:Condition", "conditions": [ { "and": #andURI, "conditionType": "drmo:Condition", "conditions": [ { "and": #andURI, "conditionType": "drmo:Condition", "conditions": [ ], "constraintOnGraph": null, "constraintOnObject": null, "constraintOnProperty": null, "constraintOnSubject": null, "guid": "#guid_2", "isNegated": false, "or": #orURI, "preceededBy": #precURI, "propertyOperator": null, "resourceType": "pimo:PersonGroup", "succeededBy": #succURI } ], "constraintOnGraph": null, "constraintOnObject": #object, "constraintOnProperty": "nso:sharedWith", "constraintOnSubject": null,   "guid": "#guid_1", "isNegated": false, "or": #orURI, "preceededBy": #precURI, "propertyOperator": null, "resourceType": #resourceType, "succeededBy": #succURI } ], "constraintOnGraph": null, "constraintOnObject": null, "constraintOnProperty": null, "constraintOnSubject": null, "guid": "#guid", "isNegated": false, "or": #orURI, "preceededBy": #precURI, "propertyOperator": null, "resourceType": #resourceType, "succeededBy": #succURI }',
			//NOTE: instead of returning person type we return account -> sharedwith in reality links to an account. The person owner of a matched account will be linked at triggering stage.
			jsonPerson: '{ "and": #andURI, "conditionType": "drmo:Condition", "conditions": [ { "and": #andURI, "conditionType": "drmo:Condition", "conditions": [ ], "constraintOnGraph": null,           "constraintOnObject":  { "and": #andURI, "conditionType": "drmo:Condition", "conditions": [ ], "constraintOnGraph": null,	"constraintOnObject": "di.me", "constraintOnProperty": "dao:accountType", 	"constraintOnSubject": null, "guid": "#guid_2", "isNegated": false, "or": #orURI, "preceededBy": #precURI, "propertyOperator": null, "resourceType": "dao:Account", "succeededBy": #succURI },            "constraintOnProperty": "nso:sharedWith", "constraintOnSubject": null, "guid": "#guid_1", "isNegated": false, "or": #orURI, "preceededBy": #precURI, "propertyOperator": null, "resourceType": #resourceType, "succeededBy": #succURI } ], "constraintOnGraph": null, "constraintOnObject": null, "constraintOnProperty": null, "constraintOnSubject": null, "guid": "#guid", "isNegated": false, "or": #orURI,   "preceededBy": #precURI, "propertyOperator": null, "resourceType": #resourceType, "succeededBy": #succURI}' 
		}
	]
	
	var commonValues = [
		//{
		//	value: -1,
		//	label: "?Any",
		//},
		//{
		//	value: -2,
		//	label: "Text Value",
		//}
	];
	
	var drmoConditions = [
		{
			value: -11,
			label: "New Item",
			ns: "drmo:ResourceCreated",
		},	
		{
			value: -12,
			label: "Modified Item",
			ns: "drmo:ResourceModified",
		},
	]
	
	
	var ops = [
		{
			name: "AND",
			label: "&",
		},	
		{
			name: "OR",
			label: "/",
		},
		{
			name: "SUCC",
			label: ">>",
		},
		{
			name: "PREC",
			label: "<<",
		},
	]
	
	var any = [
		{
			value: 0,
			label:"trustLevel"	
		}
	]
	
	var actions = [
		{
			value: 0,
			label: "Notify Me",
			image: "../../images/rules/notify.png",
		},
		{
			value: 1,
			label: "Increase Trust Level",
			image: "../../images/rules/increasetrust.png",
		},
		{
			value: 2,
			label: "Decrease Trust Level",
			image: "../../images/rules/decreasetrust.png",
		},
		{
			value: 3,
			label: "Share Item",
			image: "../../images/rules/share.png",
		},
//		{
//			value: 2,
//			label: "Change Availability",
//			image: "../../images/rules/change.png",
//		},
//		{
	//		value: 3,
//			label: "SMS",
			//image: "images/sms.png",
//		},
		{
			value: 4,
			label: "Increase Privacy Level",
			image: "../../images/rules/increaseprivacy.png",
		},
				{
			value: 5,
			label: "Decrease Privacy Level",
			image: "../../images/rules/decreaseprivacy.png",
		},

	]
</script>
	
<script>
var drgClone = null;
$(function() {
   
	
$( ".controlbox" ).accordion({ heightStyle: "content" } );
});	

$(document).on("click","#newRuleButton", function() { 
									$(".allRules").prepend(createRuleBox());
									//To allow only 1 rule editing/creation, hide rule after click
									$(this).find(".createButton").hide(); 
									createConditionBox(currentRuleId);
									//hide message text box
									$(document).find("#notificationText").hide(); 
									$(document).find("#saveButton").hide(); 
									reactivateDraggableTypes();
	//								reactivateDraggableOperators();
									reactivateDraggableActions();
									$(".controlbox").accordion("option", "active", 0);
									return true;
									});
									
					
$(document).on("keypress", ".rulebox", function(event){ 
													var value = conditionsKeyPress.get($(this).attr("id")) + 1;
													conditionsKeyPress.put($(this).attr("id"),value);
													});

//$(document).on("mouseover", ".rulebox", function(event){ 
//												var value = conditionsMousePress.get($(this).attr("id")) + 1;
//												conditionsMousePress.put($(this).attr("id"),value);
//											});
												


									
$(document).ready(function(){
	//load types
	$.each(types, function(index , data){
		var id = data.value;
		if (data.value != 0)
		{
		var name = data.label;
		var image = data.image;
		var createDiv = "<div style='border:dotted thin #999999; background-color: rgb(246, 194, 0); margin-top:5px; margin-right:5px; margin-left:5px; margin-bottom:5px; width:35px; height:35px; float:left'><div class='draggable' title='"+name+"' name='"+id+"'><img src='"+image+"'width='30' height='30' alt='"+name+"' /></div></div>";
		$(document).find("#controlbox_Types").append(createDiv);
		}
	});

//Function removed as we are only supporting & operator (simple buttom will do)
/*
/*	
	//operators
	$.each(ops, function(index , data){
		var name = data.name;
		var label = data.label;
		var createDiv = "<div style='border:dotted thin #999999; margin-top:5px; margin-right:5px; margin-left:5px; margin-bottom:5px; width:20px; height:20px; float:left'><div class='draggableOperator' title='"+name+"'>"+label+"</div></div>";
		$(document).find("#controlbox_Operator").append(createDiv);
	});
*/

	//actions
	$.each(actions, function(index , data){
		var id = data.id;
		var value = data.value;
		var name = data.label;
		var image = data.image;
		var createDiv = "<div style='border:dotted thin rgb(102, 102, 51); background-color: rgb(90, 157, 213); margin-top:2px; margin-right:2px; margin-left:2px; margin-bottom:2px; width:40px; height:40x; float:left'><div class='draggableAction' title='"+name+"' name='"+id+"' value='"+value+"'><img src='"+image+"'width='30' height='30' alt='"+name+"' /></div></div>";

		$(document).find("#controlbox_Actions").append(createDiv);
	});
	$(document).find("#newRuleButton").click();
	$(document).find("#newRuleButton").hide();
	
});

function reactivateDraggableActions(){
	$( ".draggableAction" ).draggable({ helper:'clone', snap: ".action", snapMode: "inner", start: function() {
		drgClone = $(this).clone(true)
	}});
	$(".action").droppable({
	  accept: '.draggableAction',
	  drop: function( event, ui ) {
		$(this).find(".helper").hide(); 
		$(this).find(".helper3").hide();		
		$(this).find(".draggableAction").remove(".draggableAction");
		$(this).append(drgClone);
		//show message text box + default message.
		if (drgClone.attr("value") == 1) {
			$(document).find("#notificationText").val("Trust-level increased after sharing.");
		} else {
			$(document).find("#notificationText").val("Enter a personalised notification message here.");
		}
		$(document).find("#notificationText").show(); 
		$(document).find("#saveButton").show(); 
  	    document.getElementById('menu')
	  }
	});
}


function reactivateDraggableTypes(){
	$( ".draggable" ).draggable({ helper:'clone', snap: ".autocompleteFillInCondition", snapMode: "inner", start: function() {
		drgClone = $(this).clone(true)
		currentTypeId = $(this).attr("name");
	}});
	$(".autocompleteFillInCondition").droppable({
	  accept: '.draggable',
	  drop: function( event, ui ) {
		var ruleId = ($(this).parents(".rulebox")).attr("id");
		var value = conditionsMousePress.get(ruleId) + 1;
		conditionsMousePress.put(ruleId,value);
		$(this).find(".helper").hide();  
		   $(this).find(".draggable").remove(".draggable");
		   $(this).find(".helper3").hide();
		$(this).append(drgClone)
		addProperties();
	  }
	});
}

//Function removed as we are only supporting & operator (simple buttom will do)
/*
function reactivateDraggableOperators(){
	$( ".draggableOperator" ).draggable({ helper:'clone', snap: ".newConditionButton", snapMode: "inner", start: function() {
		drgClone = $(this).clone(true)
	}});
	$(".newConditionButton").droppable({
		  accept: '.draggableOperator',
		  drop: function( event, ui ) {
				var ruleId = ($(this).parents(".rulebox")).attr("id");
		var value = conditionsMousePress.get(ruleId) + 1;
		conditionsMousePress.put(ruleId,value);
			  $(this).find(".helper").hide();  
			   $(this).find(".draggableOperator").remove(".draggableOperator");
			$(this).append(drgClone);
			createConditionBox(currentRuleId);
			reactivateDraggableTypes();
			reactivateDraggableOperators();
			$(".controlbox").accordion("option", "active", 0);
		  }
		});
}
*/

function addProperties(){
	//clear sidebar
	$(document).find("#controlbox_Properties").html("");
	//enable property
	
	$("#"+currentConditionId).attr("data-typeid",currentTypeId);
	$("#"+currentConditionId).parent().find(".autocompleteFillInProperty").css("background-color","#9CC6E6");
	$("#"+currentConditionId).parent().find(".autocompleteFillInConstraint").css("background-color","#FFFFAA");
	//$("#"+currentConditionId).parent().find(".helper2").text("Filter");
	
	
	var propValue = currentTypeId;
	var arrayValues = [];
	
		//situation
	if (propValue == 3){
			//disable property
		$("#"+currentConditionId).parent().find(".autocompleteFillInProperty").css("background-color","#999");
//		$("#"+currentConditionId).parent().find(".helper2").text("");
						
		addConstraints($(this));
	} else {
		$("#"+currentConditionId).parent().find(".autocompleteFillInConstraint").css("background-color","#999"); 
		if (!((propValue == 4) || (propValue == 5)))
		{
			$.ajax({
					async: false,
					url: '/dime-communications/api/dime/rest/'+said+'/sparql',
					dataType: 'json',
					type: 'GET',
					data: { 
						queryLn: 'SPARQL',
						query: types[propValue].propertyQuery, 
						limit: 'none',
						infer: 'true',
						Accept: 'application/sparql-results+json'
					},
					success: function(data){
						arrayValues = $.map(data.results.bindings, function(item, index){
							return {
								value:  index,
								id: item["x"].value,
								label: (item["label"].value != null) ? item["label"].value : item["x"].value,
							}
						})
					},
					error: displayError,
					crossdomain: true
				});
		}
			
		
	arrayValues = ((propValue == 4) || (propValue == 5)) ? drmoConditions.concat(arrayValues) : arrayValues;
	arrayValues = ((propValue == 4) || (propValue == 5)) ? hardCodedSharedWithProperty.concat(arrayValues) : arrayValues;
	
	arrayValues = (propValue == 6) ? hardCodedLivePostProperties.concat(arrayValues) : arrayValues;
	$.each(arrayValues, function(index , data){
		var id = data.value;
		var name = data.label;
		var uri = data.id;
		var createDiv = "<div style='background-color:rgb(156, 198, 230); border:thin dotted rgb(153, 153, 153); margin-top:5px; margin-right:5px; width:120px; height:18px; float:left'><div class='draggableProperties' title='"+name+"' name='"+id+"' tag='"+uri+"'>"+name+"</div></div>";
		$(document).find("#controlbox_Properties").append(createDiv);
	});
	
	//Add the draggable property
	$( ".draggableProperties" ).draggable({ helper:'clone', snap: ".autocompleteFillInProperty", snapMode: "inner", start: function() {
					drgClone = $(this).clone(true);
					currentPropertyId = $(this).attr("name");
					currentURITag = $(this).attr("tag");
				}});
	$(".autocompleteFillInProperty").droppable({
				  accept: '.draggableProperties',
				  drop: function( event, ui ) {
					  		var ruleId = ($(this).parents(".rulebox")).attr("id");
		var value = conditionsMousePress.get(ruleId) + 1;
		conditionsMousePress.put(ruleId,value);
					   $(this).find(".helper").hide();   
					$(this).find(".draggableProperties").remove(".draggableProperties");
					$(this).append(drgClone);
					addConstraints($(this));
				  }
				});
					
		$(".controlbox").accordion("option", "active", 1);
	}
}

function addConstraints(element){
		$(document).find("#controlbox_Values").html("");
		$("#"+currentConditionId).parent().find(".autocompleteFillInConstraint").css("background-color","#FFFFAA");
		var propValue = currentTypeId;
		var consValue = currentPropertyId;
		var propertyUri = "<"+currentURITag+">";
		
		var arrayValues = [];
		
		var constraintQuery = "";
		var sparqlConstraintId = "";
		
		//for new or modified resources, do not show constraint and skip to actions  
		if ((consValue == -11) || (consValue == -12) ){
			$("#"+currentConditionId).parent().find(".autocompleteFillInConstraint").css("background-color","#999");
			if (propValue == 4){ 
								//$("#"+currentConditionId).parent().find(".helper5").text("Any Image");
			                        $("#"+currentConditionId).parent().find(".draggableConstraints").text("Any Image");
		//							$("#"+currentConditionId).parent().find(".draggableConstraints").setAttribute("tag","any");
			} else  if (propValue == 5){ 
								//$("#"+currentConditionId).parent().find(".helper5").text("Any Document");
									$("#"+currentConditionId).parent().find(".draggableConstraints").text("Any Document");
		//							$("#"+currentConditionId).parent().find(".draggableConstraints").setAttribute("tag","any");

			}
		
		$(".controlbox").accordion("option", "active", 3);		
		}
		else {
		//nearby people
		if ((propValue == 1) && (consValue == 0) ){
			constraintQuery = peerConstraints[consValue].constraintQuery;
//			$("#"+currentConditionId).parent().find(".helper5").text("Specific Person"); 
			constraintId = peerConstraints[consValue].constraintId; }

		else if ((propValue == 1) && (consValue == 1) ){
			constraintQuery = peerConstraints[consValue].constraintQuery;
//			$("#"+currentConditionId).parent().find(".helper5").text("Specific Group");	
			constraintId = peerConstraints[consValue].constraintId; }

		else if (propValue == 3){
			constraintQuery = types[propValue].constraintQuery ;
			constraintId = types[propValue].constraintId;
//			$("#"+currentConditionId).parent().find(".helper5").text("Specific Situation");
		}
		else { 
			constraintQuery = types[propValue].constraintQuery ;
			constraintId = types[propValue].constraintId;
//			$("#"+currentConditionId).parent().find(".helper5").text("Specific Item");
		}
		
		//state (activity/availability)
		if (propValue == 2){
			if(propertyUri.indexOf("Availability")) propertyUri = propertyUri.replace(/dcon#currentAvailability/g,"dpo#Availability");
			if(propertyUri.indexOf("Activity")) propertyUri = propertyUri.replace(/dcon#currentActivity/g,"dpo#Activity");
			constraintQuery = constraintQuery.replace("#propertytype#",propertyUri);
		}
		
		if ((propValue == 6) && (consValue > -1)) {
			constraintQuery = constraintQuery.replace(/#property#/g,propertyUri);
//			$("#"+currentConditionId).parent().find(".helper5").text("Specific Post");
		}
		
		
		

		//live post created by
		if (consValue == -1){
			constraintQuery = hardCodedLivePostProperties[0].constraintQuery ;
			constraintId = hardCodedLivePostProperties[0].constraintId;
	//		$("#"+currentConditionId).parent().find(".helper5").text("Specific Person");
		}
		
		//image/doc shared with
		if (consValue == -3){
			constraintQuery = hardCodedSharedWithProperty[0].constraintQuery ;
			constraintId = hardCodedSharedWithProperty[0].constraintId;
//			$("#"+currentConditionId).parent().find(".helper5").text("Specific Person");
		}
		
		$.ajax({
				async: false,
				url: '/dime-communications/api/dime/rest/'+said+'/sparql',
				dataType: 'json',
				type: 'GET',
				data: { 
					queryLn: 'SPARQL',
					query: constraintQuery, 
					limit: 'none',
					infer: 'true',
					Accept: 'application/sparql-results+json'
				},
				success: function(data){
					arrayValues = $.map(data.results.bindings, function(item, index){
						return {
							value:  index,
							id: item[constraintId].value,
							label: (item["label"] != null)  ? item["label"].value : item["x"].value,
						}
					})
				},
				error: displayError,
				crossdomain: true
			});
			
	arrayValues =	commonValues.concat(arrayValues);
	$.each(arrayValues, function(index , data){
		var id = data.value;
		var name = data.label;
		var uri = data.id;
		if (id == -2){
			var createDiv = "<div style='background-color: rgb(255, 255, 170); border:thin dotted rgb(153, 153, 153); margin-top:5px; margin-right:5px; width:120px; height:18px; float:left'><div class='draggableConstraints' title='"+name+"' name='"+id+"'><input class='text' /><br>Textbox</div></div>"
		} else {
			var createDiv = "<div style='background-color: rgb(255, 255, 170); border:thin dotted rgb(153, 153, 153); margin-top:5px; margin-right:5px; width:120px; height:18px; float:left'><div class='draggableConstraints' title='"+name+"' name='"+id+"' tag='"+uri+"'>"+name+"</div></div>";
		}
		$(document).find("#controlbox_Values").append(createDiv);
	});
	
	//Add the draggable constraints
	$( ".draggableConstraints" ).draggable({ helper:'clone', snap: ".autocompleteFillInConstraint", snapMode: "inner", start: function() {
					drgClone = $(this).clone(true);
					currentValueId = $(this).attr("name");
				}});
	$(".autocompleteFillInConstraint").droppable({
				  accept: '.draggableConstraints',
				  drop: function( event, ui ) {
					  		var ruleId = ($(this).parents(".rulebox")).attr("id");
		var value = conditionsMousePress.get(ruleId) + 1;
		conditionsMousePress.put(ruleId,value);
					  $(this).find(".helper").hide();  
					$(this).find(".draggableConstraints").remove(".draggableConstraints");
					$(this).append(drgClone);
					
					//after the dragged constrained is appended to the condition box, swithc to the action view
					$(".controlbox").accordion("option", "active", 3);	
					if (currentValueId == -1){
						//?Any is chosen
						var condId = currentConditionId;
						var currCounter = conditionsHashMap.get(currentRuleId);
						$("#constraintdiv_"+currCounter+"_"+condId).append("<br clear='all'/>");
						constraintBox(condId,currCounter);
						//ANY query - used only for evaluation
						//getPropertiesForAny();
						
					};
				  }
				});		
	$(".controlbox").accordion("option", "active", 2);	
	}
}

	 function displayError(xhr, textStatus, errorThrown) {
		alert(errorThrown);
		alert(textStatus);
	 }
	 
	function createRuleBox(){
		var boxId = makeid();
		conditionsKeyPress.put(boxId,0);
		conditionsMousePress.put(boxId,0);
		var boxCode = "<div id='"+boxId+"' class='rulebox'>"+
		"<div style='color:rgb(49, 48, 49); font-size:20px; font-weight:bold; font-family:Helvetica,Arial,sans-serif; margin-top:10px; margin-left:5px; margin-right:5px; float:left'>if</div> <div id='conditions_"+boxId+"'><div id='conditiondiv_1_"+boxId+"' class='conditionBox'></div></div><div><a href='#' name='newConditionButton' title='Add Another Condition' id='newConditionButton' class='newConditionButton'>+</a></div><div style='color:rgb(49, 48, 49); font-size:20px; font-weight:bold; font-family:Helvetica,Arial,sans-serif; margin-top:10px; margin-left:5px; margin-right:5px; float:left'>then</div> <div class='action'><span class='helper'>A</span><span class='helper3'>ction</span><span style='float:right'><input id='notificationText' type='text' style='width:300px; color:rgb(49, 48, 49); font-style:italic; height:20px; border: 1px dotted #000000; margin:5px 5px 5px 5px; word-wrap:break-word; padding:0px'></span></div><a href='#' name='"+boxId+"' id='saveButton' class='saveButton'>Save</a><br clear='all'/>"+
		"</div>"+
		"<div id='tutorialBox' class ='tutorialBox'><span style='float:left; background-color:rgb(246, 194, 0)'><img src='../img/metaData/info.png'><span style='vertical-align:middle' id='tipTitle' class='tipTitle'>Guide: Step 1</span><br><div id='tipBox' class='tipBox'><span id='tipText' style='text-align:center' class='tipText'>Select an Object to start describing a condition e.g., 'Nearby People', from the list on the right. Drag it onto the yellow box on the left. </span></div><a href='#' style='float:right; vertical-align:middle' name='nextTipButton' id='nextTipButton' title='Show Next Tip' class='nextTipButton'>&gt;&gt; Go to Step 2</a></span><div style='float:left'><img id='tutorial' src='../../images/rules/tutorial/tutorial0_faded.png' alt='5-step Guidelines'></div></div>";
		currentRuleId = boxId;

		return boxCode;
	}

	function createConditionBox(id){
		currentURITag = "";
		currentPropertyId = -100;
		if (conditionsHashMap.get(id) != null){
			var condValue = conditionsHashMap.get(id);
			conditionBox(id, condValue);
			condValue++;
			conditionsHashMap.put(id, condValue);
		} else {
			conditionBox(id, 0);
			conditionsHashMap.put(id, 1);
		}
	}
	
	function conditionBox(id, counter){
		var thisCounter = counter + 1;
		var nextCounter = thisCounter + 1;
		var conditionId = "condition_"+thisCounter+"_"+id;
		var divId = "conditiondiv_"+ nextCounter +"_"+id;
		var conditionButtonId = "addConditionButton_"+id;
		currentConditionId = "condition_"+thisCounter+"_"+id;
		
		var textbox = "<div class='autocompleteFillInCondition' id='"+conditionId+"' data-typeid='-1'><span class='helper'>O</span><span class='helper3'>bject</span></div><div class='constraintBox' id='constraintdiv_"+thisCounter+"_"+conditionId+"'></div>"
		$("#conditiondiv_"+thisCounter+"_"+id).append(textbox);
		$("#conditions_"+id).append("<div id='"+divId+"' class='conditionBox'></div>");
		constraintBox(conditionId,thisCounter);		
		
	}
	
	function constraintBox(id, counter){
		var propertyId = "property_"+id+"_"+counter;
		var constraintId = "constraint_"+id+"_"+counter;
		var textbox = "<br clear='all' /><div class='autocompleteFillInProperty' id='"+propertyId+"'><div class='draggableProperties' title='null'><span class='helper2'></span></div></div><br clear='all' /><div class='autocompleteFillInConstraint' id='"+constraintId+"'><div class='draggableConstraints' title='null'><span class='helper5'></span></div></div>";	
		
//		Operator removed from inside condition box
//		<div class='newConditionButton'><div class='draggableOperator' title='null'><span class='helper'>Operator</span></div></div><br clear='all' />
		
		$("#constraintdiv_"+counter+"_"+id).append(textbox);
		createConditionObject(id,propertyId,constraintId);
	}
	
	function createConditionObject(conditionId, propertyId, constraintId){
		var object = new Object();
		object.condition = conditionId;
		object.property = propertyId;
		object.constraint = constraintId;

		conditionObjects.put(conditionId, object);
		conditionObjects.put(propertyId, object);
		conditionObjects.put(constraintId, object);
	}
	
	function makeid(){    
   		var text = "";
   		var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

    	for( var i=0; i < 5; i++ )
        	text += possible.charAt(Math.floor(Math.random() * possible.length));

    	return text;
	}

    $(document).on("click",".newConditionButton", function() { 
	
				createConditionBox(currentRuleId);
				reactivateDraggableTypes();
				$(".controlbox").accordion("option", "active", 0);  
				conditions = conditions + 1;
				//disallow more than 2 conditions
				if (conditions ==2) $(document).find("#newConditionButton").hide(); 	
		});
	
	$(document).on("click",".nextTipButton", function() { 
				if (tutorialCounter == 1) {
											document.getElementById('tutorial').src = "../../images/rules/tutorial/tutorial1_faded.png";
										    document.getElementById('nextTipButton').innerHTML = "&gt;&gt; Go to Step 3";
											document.getElementById('tipTitle').innerHTML = "Guide: Step 2";
											document.getElementById('tipText').innerHTML = "Select a Filter for the chosen object e.g., 'Nearby Group', from the list on the right. Drag it onto the light-blue box on the left.";
											
											
											
											}
				else if (tutorialCounter == 2) {
												document.getElementById('tutorial').src = "../../images/rules/tutorial/tutorial2_faded.png";
										    	    document.getElementById('nextTipButton').innerHTML = "&gt;&gt; Go to Step 4";
											document.getElementById('tipTitle').innerHTML = "Guide: Step 3";
											document.getElementById('tutorial').src = "../../images/rules/tutorial/tutorial2_faded.png";
											document.getElementById('tipText').innerHTML = "Select a Specific Item where necessary, e.g., 'Friends', from the list on the right. Drag it onto the light-yellow box on the left.";
											}

				else if (tutorialCounter == 3) {
												    document.getElementById('nextTipButton').innerHTML = "&gt;&gt; Go to Step 5";
											document.getElementById('tipTitle').innerHTML = "Guide: Step 4";
											document.getElementById('tutorial').src = "../../images/rules/tutorial/tutorial3_faded.png";
											document.getElementById('tipText').innerHTML = "Combine more conditions (up to 3) if desired, by clicking on the '+' button. Repeat Steps 1-3 for each.";
										  }
				else if (tutorialCounter == 4) {
											document.getElementById('nextTipButton').innerHTML = "&gt;&gt; Restart Guide";
											document.getElementById('tipTitle').innerHTML = "Guide: Step 5";
											document.getElementById('tutorial').src = "../../images/rules/tutorial/tutorial4_faded.png";
											document.getElementById('tipText').innerHTML = "Select an Action, e.g. 'Notify Me', from the list on the right. Drag it onto the dark-blue box on the left, add a notification message and click 'Save'.";
											}
				else if (tutorialCounter == 5) {
											 document.getElementById('nextTipButton').innerHTML = "&gt;&gt; Go to Step 2";
											document.getElementById('tipTitle').innerHTML = "Guide: Step 1";
												document.getElementById('tutorial').src = "../../images/rules/tutorial/tutorial0_faded.png";
												tutorialCounter=0;
											document.getElementById('tipText').innerHTML = "Select an Object to start describing a condition e.g., 'Nearby People', from the list on the right. Drag it onto the yellow box on the left.";
										   
											}

				tutorialCounter = tutorialCounter + 1;
				});

									

	
	$(document).on("click", ".saveButton", function(){
    $(this).css("visibility","hidden");

    var conditionBoxId = $(this).attr("name");
    var condition = $("#"+conditionBoxId+" .autocompleteFillInCondition");
    var property = $("#"+conditionBoxId+" .autocompleteFillInProperty .draggableProperties");
    var constraint = $("#"+conditionBoxId+" .autocompleteFillInConstraint .draggableConstraints");
    //var operators = $("#"+conditionBoxId+" .newConditionButton .draggableOperator");
    var action = $("#"+conditionBoxId+" .draggableAction").attr("value");
	var notification = $("#"+conditionBoxId+" #notificationText").val();
	
	var jsonRule = createJson(action, notification);
    var conditions = "";
    var arrayLen = condition.length;
    var nextURI = 'urn:uuid:'+UUID();
	var conditionNumber = 0;
	
    $.each( condition, function(index, value) {
      //escaping situations for demo - otherwise they can halt the system
	  if (!(conditionType == 3)
	  {
	  conditionNumber = conditionNumber + 1;
	  var conditionType = $(value).attr("data-typeid");
	  var conditionJson;
      
      if (conditionType == 1){
        var valType = parseInt($(property[index]).attr("name"));
        conditionJson = peerConstraints[valType].json;
	  }
        
      else if ((conditionType == 4) || (conditionType == 5)){
        var valType = parseInt($(property[index]).attr("name"));
        var sharedWithflag=new Boolean();
		sharedWithflag = 0;  
		
		//if ANY
		if ( ($(property[index]).attr("title") == "New Item") || ($(property[index]).attr("title") == "Modified Item") ){
			conditionJson = types[conditionType].json;
		}
        //group first, since person can be contained in both pimo#Person and pimo#PersonGroup
		else if ($(constraint[index]).attr("tag").indexOf("Group") > -1){
          conditionJson = hardCodedSharedWithProperty[0].jsonGroup;
		  sharedWithflag = 1;
        } else if ($(constraint[index]).attr("tag").indexOf("Person") > -1) {
          conditionJson = hardCodedSharedWithProperty[0].jsonPerson;
		  sharedWithflag = 1;
        } else {
          conditionJson = types[conditionType].json; 
        }
      } else {
        conditionJson = types[conditionType].json;
      }

      conditionJson = conditionJson.replace("#object", '"'+$(constraint[index]).attr("tag")+'"');
      conditionJson = conditionJson.replace("#subject", '"'+$(constraint[index]).attr("tag")+'"');
      conditionJson = conditionJson.replace(new RegExp("#guid","g"), nextURI);
	  
	  //change costraintOnProperty for others
      conditionJson = conditionJson.replace("#property", '"'+$(property[index]).attr("tag")+'"');
                    
      if ( ((conditionType == 4) || (conditionType == 5)) ) 
	  {
       if (!sharedWithflag) { conditionJson = conditionJson.replace("#conditionType", '"'+drmoConditions[Math.abs( parseInt($(property[index]).attr("name")) + 11)].ns+'"'); }
	   else {
				if (conditionType == 4) { conditionJson =  conditionJson.replace(/#resourceType/g, '"nfo:Image"'); }
				else conditionJson = conditionJson.replace(/#resourceType/g, '"nfo:Document"');
			}
      }
          
	  nextURI = 'urn:uuid:'+UUID();
	  if ((arrayLen > 1) && (conditionNumber < arrayLen))
	  {
		conditionJson = conditionJson.replace(/#andURI/g, '"'+nextURI+'"');
        
	  } else {
		conditionJson = conditionJson.replace(/#andURI/g, "null");	
	  }
	  conditionJson = conditionJson.replace(/#orURI/g, "null");
      conditionJson = conditionJson.replace(/#precURI/g, "null");
      conditionJson = conditionJson.replace(/#succURI/g, "null");
	  
	  /*
	  operator = $(operators[index]).attr("title");
      nextURI = 'urn:uuid:'+UUID();
      if (operator == "AND"){
        conditionJson = conditionJson.replace(/#andURI/g, '"'+nextURI+'"');
        conditionJson = conditionJson.replace(/#orURI/g, "null");
        conditionJson = conditionJson.replace(/#precURI/g, "null");
        conditionJson = conditionJson.replace(/#succURI/g, "null");
      }
      if (operator == "OR"){
        conditionJson = conditionJson.replace(/#orURI/g, '"'+nextURI+'"');
        conditionJson = conditionJson.replace(/#andURI/g, "null");
        conditionJson = conditionJson.replace(/#precURI/g, "null");
        conditionJson = conditionJson.replace(/#succURI/g, "null");
      }
      if (operator == "PREC"){
        conditionJson = conditionJson.replace(/#precURI/g, '"'+nextURI+'"');
        conditionJson = conditionJson.replace(/#orURI/g, "null");
        conditionJson = conditionJson.replace(/#andURI/g, "null");
        conditionJson = conditionJson.replace(/#succURI/g, "null");
      }
      if (operator == "SUCC"){
        conditionJson = conditionJson.replace(/#succURI/g, '"'+nextURI+'"');
        conditionJson = conditionJson.replace(/#orURI/g, "null");
        conditionJson = conditionJson.replace(/#precURI/g, "null");
        conditionJson = conditionJson.replace(/#andURI/g, "null");
      }
      //undefined is due to operator being removed from the condition box, so no matter how many conditions there will always be one..
	  if ( (operator == "null") || (operator == undefined) ){
        conditionJson = conditionJson.replace(/#andURI/g, "null");
        conditionJson = conditionJson.replace(/#orURI/g, "null");
        conditionJson = conditionJson.replace(/#precURI/g, "null");
        conditionJson = conditionJson.replace(/#succURI/g, "null");
      }
      */
	  
	  // replace all namespaces
	  conditionJson = conditionJson.replace(/drmo:/g, "http://www.semanticdesktop.org/ontologies/2012/03/06/drmo#");
	  conditionJson = conditionJson.replace(/dcon:/g, "http://www.semanticdesktop.org/ontologies/2011/10/05/dcon#");
	  conditionJson = conditionJson.replace(/dlpo:/g, "http://www.semanticdesktop.org/ontologies/2011/10/05/dlpo#");
	  conditionJson = conditionJson.replace(/pimo:/g, "http://www.semanticdesktop.org/ontologies/2007/11/01/pimo#");
	  conditionJson = conditionJson.replace(/nso:/g, "http://www.semanticdesktop.org/ontologies/2009/11/08/nso#");
	  conditionJson = conditionJson.replace(/dao:/g, "http://www.semanticdesktop.org/ontologies/2011/10/05/dao#");
	  conditionJson = conditionJson.replace(/ddo:/g, "http://www.semanticdesktop.org/ontologies/2011/10/05/ddo#");
	  conditionJson = conditionJson.replace(/nrl:/g, "http://www.semanticdesktop.org/ontologies/2007/08/15/nrl#");
	  conditionJson = conditionJson.replace(/nie:/g, "http://www.semanticdesktop.org/ontologies/2007/01/19/nie#");
	  conditionJson = conditionJson.replace(/nfo:/g, "http://www.semanticdesktop.org/ontologies/2007/03/22/nfo#");
	  conditionJson = conditionJson.replace(/ncal:/g, "http://www.semanticdesktop.org/ontologies/2007/04/02/ncal#");
	  conditionJson = conditionJson.replace(/nao:/g, "http://www.semanticdesktop.org/ontologies/2007/08/15/nao#");
	  conditionJson = conditionJson.replace(/dpo:/g, "http://www.semanticdesktop.org/ontologies/2011/10/05/dpo#");
	  conditionJson = conditionJson.replace(/ppo:/g, "http://vocab.deri.ie/ppo#");
	  
      conditions = conditions.concat(conditionJson);
      if (index < (arrayLen - 1)) { conditions = conditions.concat(","); }
    }
	}
  );
                
    jsonRule = jsonRule.replace("#conditions", conditions);
    jsonRule = JSON.parse(jsonRule);
    console.log("Saving rule in PS: " + jsonRule);

    var payload = {
      "request":{
        "meta":{"v":"0.9","status":"OK","code":200,"timeRef":(new Date()).getTime()},
        "data":{"startIndex":0,"itemsPerPage":1,"totalResults":1,"entry":[jsonRule]}
      }
    };
    console.log(payload);
    
    $.ajax({
        type: "POST",
        dataType: "json",
        contentType: "application/json",
        data: JSON.stringify(payload),
        url: "/dime-communications/api/dime/rest/"+said+"/rule/@me"
    }).done(function(response) {
        alert("Rule Saved!");
    }).fail(function(xhr, error) {
        console.debug(xhr);
        console.debug(error);
        alert("Sorry! This rule couldn't be saved.");
    });
    
   });
		
		function createJson(actionType, notificationText){
			//increase trust level
			if (notificationText == "Enter a personalised notification message here.") notificationText = "A Rule Has Fired";

			if (actionType == 1)
			     return '{ "actions": [ { "actionType":"urn:actions:ITL", "hasObject":"'+notificationText+'"} ], "condition":[ #conditions ], "guid":"urn:uuid:'+UUID()+'", "isEnabled":true, "name":null, "type":"RULE"}';
			//Notify
			else return '{ "actions": [ { "actionType":"urn:actions:Notify", "hasObject":"'+notificationText+'"} ], "condition":[ #conditions ], "guid":"urn:uuid:'+UUID()+'", "isEnabled":true, "name":null, "type":"RULE"}';
		}
		
		function UUID() {
		    var uuid = (function () {
		        var i,
		            c = "89ab",
		            u = [];
		        for (i = 0; i < 36; i += 1) {
		            u[i] = (Math.random() * 16 | 0).toString(16);
		        }
		        u[8] = u[13] = u[18] = u[23] = "-";
		        u[14] = "4";
		        u[19] = c.charAt(Math.random() * 4 | 0);
		        return u.join("");
		    })();
		    return {
		        toString: function () {
		            return uuid;
		        },
		        valueOf: function () {
		            return uuid;
		        }
		    };
		}
	
					/*	$(document)
							.on("click", ".saveButton", function() {
							$(this)
								.css("visibility", "hidden");
							var conditionBoxId = $(this)
								.attr("name");
							var condition = $("#" + conditionBoxId + " .autocompleteFillInCondition .draggable");
							var property = $("#" + conditionBoxId + " .autocompleteFillInProperty .draggableProperties");
							var constraint = $("#" + conditionBoxId + " .autocompleteFillInConstraint .draggableConstraints");
							var operators = $("#" + conditionBoxId + " .newConditionButton .draggableOperator");
							var action = $("#" + conditionBoxId + " .action");
							var ruleString = conditionBoxId + "*"
					
							$.each(condition, function(index, value) {
								ruleString = ruleString.concat($(value)
									.attr("title") + ":");
								ruleString = ruleString.concat("{" + $(property[index])
									.attr("title") + " - ");
								ruleString = ruleString.concat($(constraint[index])
									.attr("title") + "}");
								ruleString = ruleString.concat("*")
								ruleString = ruleString.concat($(operators[index])
									.attr("title"));
								ruleString = ruleString.concat("*")
							});
							if (($(property)
								.length > $(condition)
								.length) || ($(constraint)
								.length > $(condition)
								.length)) {
								ruleString = ruleString.concat("{" + $(property[$(property)
									.length - 1])
									.attr("title") + " - ");
								var consVar = $(constraint[$(constraint)
									.length - 1])
									.attr("title") + "}"
								ruleString = ruleString.concat(consVar);
							}
							ruleString = ruleString.concat("*");
							ruleString = ruleString.concat("keypress: " + conditionsKeyPress.get($(this)
								.attr("name")));
							ruleString = ruleString.concat("*");
							ruleString = ruleString.concat("mouseclicks: " + conditionsMousePress.get($(this)
								.attr("name")));
							ruleString = ruleString.concat("*");
							ruleString = ruleString.concat("*");
							ruleString = ruleString.replace("#", "_");
							$.ajax({
								type: "GET",
								url: "http://localhost/~jeremy/_savedrules/lego/saverule.php",
								data: "data=" + ruleString + "&user=" + user,
								success: alert("saved"),

							});
						});
					*/					
					

/* The following two functions where only used for the evaluation to add the 'any' property + constraint for the visual UI, but do not really work otherwise
					
					function getPropertiesForAny(){
	$(document).find("#controlbox_Properties").html("");
	
	$.each(any, function(index , data){
		var id = data.value;
		var name = data.label;
		var uri = data.id;
		var createDiv = "<div style='background-color:rgb(156, 198, 230); border:thin dotted rgb(153, 153, 153); margin-top:5px; margin-right:5px; width:120px; height:18px; float:left'><div class='draggableProperties' title='"+name+"' name='"+id+"' tag='"+uri+"'>"+name+"</div></div>";
		$(document).find("#controlbox_Properties").append(createDiv);
	});
	
	//Add the draggable property
	$( ".draggableProperties" ).draggable({ helper:'clone', snap: ".autocompleteFillInProperty", snapMode: "inner", start: function() {
					drgClone = $(this).clone(true);
					currentPropertyId = $(this).attr("name");
				}});
	$(".autocompleteFillInProperty").droppable({
				  accept: '.draggableProperties',
				  drop: function( event, ui ) {
					  		var ruleId = ($(this).parents(".rulebox")).attr("id");
		var value = conditionsMousePress.get(ruleId) + 1;
		conditionsMousePress.put(ruleId,value);
					  $(this).find(".helper").hide();  
					$(this).find(".draggableProperties").remove(".draggableProperties");
					$(this).append(drgClone);
//					addAnyConstraints();
				  }
				});
					
	$(".controlbox").accordion("option", "active", 1);
	
}
*/
					
/* function addAnyConstraints(){
		$(document).find("#controlbox_Values").html("");
	$.each(commonValues, function(index , data){
		var id = data.value;
		var name = data.label;
		var uri = data.id;
		
		if (id == -2){
			var createDiv = "<div style='background-color: rgb(255, 255, 170); border:thin dotted rgb(153, 153, 153); margin-top:5px; margin-right:5px; width:120px; height:18px; float:left'><div class='draggableConstraints' title='"+name+"' name='"+id+"'><input class='text' /><br>Textbox</div></div>"
		} else {
			var createDiv = "<div style='background-color: rgb(255, 255, 170); border:thin dotted rgb(153, 153, 153); margin-top:5px; margin-right:5px; width:120px; height:18px; float:left'><div class='draggableConstraints' title='"+name+"' name='"+id+"' tag='"+uri+"'>"+name+"</div></div>";
		}
		$(document).find("#controlbox_Values").append(createDiv);
	});
	
	//Add the draggable constraint
	$( ".draggableConstraints" ).draggable({ helper:'clone', snap: ".autocompleteFillInConstraint", snapMode: "inner", start: function() {
					drgClone = $(this).clone(true)
					currentValueId = $(this).attr("name");
				}});
	$(".autocompleteFillInConstraint").droppable({
				  accept: '.draggableConstraints',
				  drop: function( event, ui ) {
					  		var ruleId = ($(this).parents(".rulebox")).attr("id");
		var value = conditionsMousePress.get(ruleId) + 1;
		conditionsMousePress.put(ruleId,value);
					  $(this).find(".helper").hide();  
					$(this).find(".draggableConstraints").remove(".draggableConstraints");
					$(this).append(drgClone);
					
					if (currentValueId == -1){
						//?Any is chosen
						var condId = currentConditionId;
						var currCounter = conditionsHashMap.get(currentRuleId);
						$("#constraintdiv_"+currCzounter+"_"+condId).append("<br clear='all'/>");
						constraintBox(condId,currCounter);
						getPropertiesForAny();
						//ANY query
					};
					$(".controlbox").accordion("option", "active", 4);	
				  }
				});		
	
} 
*/

</script>
</head>

<body>
<div class="workspace">
	<div class="allRules">
    <br clear='all' />
    <a href="#" id="newRuleButton" class="createButton">Create Rule</a>
    </div>
    <div class="controlbox">
    	<h3>Objects</h3>
        <div id="controlbox_Types">
        </div>
        <h3>Filters</h3>
        <div id="controlbox_Properties">
        </div>
        <h3>My Items</h3>
        <div id="controlbox_Values">
        </div>
<!-- 		<h3>Join Operators (+)</h3>
		<div id="controlbox_Operator">
        </div> -->
        <h3>Actions</h3>
        <div id="controlbox_Actions">
        </div>
    </div>
    
</div>
</body>
</html>
